# DuckDB 文檔網站建置說明

## 目錄

* [DuckDB 文檔網站建置說明](#duckdb-文檔網站建置說明)
  * [目錄](#目錄)
  * [使用本機 Jekyll 安裝](#使用本機-jekyll-安裝)
    * [前置需求](#前置需求)
    * [啟動網站服務](#啟動網站服務)
  * [使用 Docker](#使用-docker)
    * [前置需求](#前置需求-1)
    * [透過 Docker 啟動網站服務](#透過-docker-啟動網站服務)
  * [使用開發容器 (Dev Container)](#使用開發容器-dev-container)
  * [生成搜尋索引](#生成搜尋索引)
  * [更新發布行事曆](#更新發布行事曆)
  * [語法高亮功能](#語法高亮功能)
  * [疑難排解](#疑難排解)
    * [Jekyll 在 Windows 上無法運作](#jekyll-在-windows-上無法運作)
    * [無法安裝相依套件](#無法安裝相依套件)
    * [Jekyll 執行失敗](#jekyll-執行失敗)
    * [Bundle 更新失敗](#bundle-更新失敗)
    * [Jekyll 內容無法正確顯示](#jekyll-內容無法正確顯示)
    * [Bundle 安裝失敗](#bundle-安裝失敗)
    * [ERROR bad URI 錯誤](#error-bad-uri-錯誤)

本網站使用 [Jekyll](https://jekyllrb.com/) 建置，這是 GitHub Pages 所採用的靜態網站產生器。

## 使用本機 Jekyll 安裝

### 前置需求

1. 本網站使用 [Jekyll](https://jekyllrb.com/) 建置。關於如何為 Jekyll 設定 Ruby 環境，請參考 [Jekyll 安裝說明頁面](https://jekyllrb.com/docs/installation/macos/)。如需安裝特定版本的 Ruby，我們建議使用 [chruby](https://jekyllrb.com/docs/installation/macos/#step-2-install-chruby-and-the-latest-ruby-with-ruby-install)。

2. 使用 Bundler 安裝 Jekyll 及其他必要的 Ruby 相依套件：

    ```bash
    bundle install
    ```

    更多關於設定 Jekyll 的詳細資訊，請參考 [GitHub 的說明文件](https://docs.github.com/en/pages/setting-up-a-github-pages-site-with-jekyll/testing-your-github-pages-site-locally-with-jekyll)。

3. 建立 Python 虛擬環境並安裝必要套件：

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    ```

### 啟動網站服務

若要啟動網站服務,請執行:

```bash
scripts/serve-latest.sh
```

接著開啟瀏覽器,前往 <http://localhost:4000/docs/> 即可瀏覽網站。

注意:為了節省建置時間,`serve-latest.sh` 腳本僅部署最新穩定版本,不包含歷史版本。若要啟動包含舊版本的完整網站,請執行:

```bash
scripts/serve.sh
```

## 使用 Docker

### 前置需求

請先安裝 [Docker](https://docs.docker.com/get-docker/)。

### 透過 Docker 啟動網站服務

為了方便攜帶和部署,我們提供了 [Docker 映像檔](Dockerfile)。

首先,使用以下指令建置映像檔:

```bash
scripts/docker-build.sh
```

啟動網站服務(僅最新版本,不包含歷史版本):

```bash
scripts/docker-serve-latest.sh
```

開啟瀏覽器並前往 <http://localhost:4000/docs/> 即可瀏覽網站。

若要啟動完整版本的網站:

```bash
scripts/docker-serve.sh
```

若要停止容器,請執行:

```bash
scripts/docker-stop.sh
```

## 使用開發容器 (Dev Container)

如果您使用 [Dev Container](https://code.visualstudio.com/docs/devcontainers/containers),請點選右上方的綠色 Code 按鈕,即可開啟一個已初始化此儲存庫的新 Codespace。

## 生成搜尋索引

若要生成搜尋索引,請執行:

```bash
scripts/install-dependencies.sh
scripts/generate-search-index.sh
```

## 更新發布行事曆

發布行事曆會由 [CI](.github/workflows/jekyll.yml) 自動更新。若要手動更新發布行事曆,請執行:

```bash
python scripts/get_calendar.py
```

## 語法高亮功能

我們使用 [Rouge 語法高亮器的分支版本](https://github.com/duckdb/rouge/blob/duckdb/lib/rouge/lexers/sql.rb),該版本擴充了標準 SQL 以外的關鍵字(例如 `RETURNING`、`ASOF`)。Bundler 會自動安裝此版本。

若要在本機測試 `rouge` 的更新,請編輯 `Gemfile`:

```diff
-gem "rouge", git: "https://github.com/duckdb/rouge.git", branch: "duckdb"
+gem "rouge", git: "/path/to/your/local/rouge/directory"
```

然後執行:

```bash
bundle install
```

## 疑難排解

### Jekyll 在 Windows 上無法運作

如果您使用 Windows,請執行以下兩個指令以確保 Jekyll 正常運作:

```bash
gem uninstall eventmachine --force
gem install eventmachine --platform ruby
```

### 無法安裝相依套件

若出現以下錯誤:

```console
posix-spawn.c:226:27: error: incompatible function pointer types passing 'int (VALUE, VALUE, posix_spawn_file_actions_t *)' (aka 'int (unsigned long, unsigned long,
```

解決方法是執行以下 `bundle` 指令:

```bash
bundle config set --global build.posix-spawn "--with-cflags=-Wno-error=incompatible-function-pointer-types"
```

### Jekyll 執行失敗

在升級 Ruby 後,Jekyll 執行時出現以下錯誤訊息:

```console
/opt/homebrew/opt/ruby/bin/bundler:25:in `load': cannot load such file -- /opt/homebrew/lib/ruby/gems/3.3.0/gems/bundler-2.5.4/exe/bundler (LoadError)
	from /opt/homebrew/opt/ruby/bin/bundler:25:in `<main>'
```

解決方法是在儲存庫中執行以下指令:

```bash
gem install bundler
bundle install
```

如果這個方法無效,您可能需要升級 Bundler 版本。請執行:

```bash
rm Gemfile.lock
bundle install
```

### Jekyll 內容無法正確顯示

動態頁面重新生成可能不會套用到 includes、railroad 圖表或其他內容。若要強制重新生成頁面或 include,以便在本機瀏覽器中正確顯示,請按照以下步驟操作:

1. 停止執行 Jekyll 建置指令的終端機會話(例如 `scripts/serve-latest.sh`)。
2. 針對您的特定頁面執行 `git add myfile.md`。
3. 停止 Jekyll 並執行 `rm -rf _site` 來清理先前產生的檔案。
4. 如果網站仍未重新生成,請執行 `git clean` 來清理儲存庫,但請小心不要遺失任何未暫存或未提交的變更。
5. 從終端機再次執行 `scripts/serve-latest.sh`。
6. 如果您正在編輯的頁面已在瀏覽器中開啟,它應該會自動重新整理。如果沒有,請手動重新整理。您本機分支的變更現在應該可見了。

### Bundle 更新失敗

Bundle 更新時出現以下錯誤訊息:

```bash
bundle update
```

```console
Git error: command `git fetch --force --quiet
/opt/homebrew/lib/ruby/gems/3.3.0/cache/bundler/git/minima-4abf4ea566b1c7c640342d1bbff5586f3c10dd05 --depth 1
1d5286cf9a1aae34078420d183d560dd673d98b5` in directory /opt/homebrew/lib/ruby/gems/3.3.0/bundler/gems/minima-1d5286cf9a1a has failed.
fatal: '/opt/homebrew/lib/ruby/gems/3.3.0/cache/bundler/git/minima-4abf4ea566b1c7c640342d1bbff5586f3c10dd05' does not appear to be a git
repository
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
```

若要解決此問題,請清理 Jekyll gem 快取:

```bash
rm -rf /opt/homebrew/lib/ruby/gems/3.3.0/cache/
```

### Bundle 安裝失敗

Bundle 安裝時出現以下錯誤訊息:

```bash
bundle install
```

```console
The running version of Bundler (2.5.11) does not match the version of the specification installed for it (2.5.18). This can be caused by
reinstalling Ruby without removing previous installation, leaving around an upgraded default version of Bundler. Reinstalling Ruby from
scratch should fix the problem.
```

根據 [Stack Overflow 的解答](https://stackoverflow.com/a/63761800),解決方法是執行:

```bash
gem update --system
```

### `ERROR bad URI` 錯誤

當嘗試透過 HTTPS 存取本機建置的網站(`https://localhost:4000/`)時,會出現以下錯誤:

```console
[2024-09-17 12:15:36] ERROR bad URI `����\x12`�\x17\x03�L\x00\x00\x14�'.
[2024-09-17 12:15:36] ERROR bad Request-Line ...
```

這種情況經常發生在強制使用 HTTPS 連線的瀏覽器(例如 Safari)上。解決方法是使用 HTTP 連線(`http://localhost:4000`),或嘗試使用其他瀏覽器(例如 Chrome 或 Firefox)。
